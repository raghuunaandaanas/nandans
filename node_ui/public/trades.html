<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Superalgo Trade Monitor | Real-time Trading Dashboard</title>
  <style>
    :root {
      --bg: #0f172a;
      --card: #111827;
      --line: #243244;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --ok: #22c55e;
      --down: #ef4444;
      --accent: #38bdf8;
      --warn: #f59e0b;
      --danger: #dc2626;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: radial-gradient(1200px 600px at 10% -20%, #23324b 0%, var(--bg) 55%);
      color: var(--text);
      font: 14px/1.4 "Segoe UI", system-ui, sans-serif;
    }
    .wrap { max-width: 2600px; margin: 0 auto; padding: 12px; }
    
    /* Header with Time */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      padding: 10px 15px;
      background: linear-gradient(180deg, #1e293b, #0f172a);
      border: 1px solid var(--line);
      border-radius: 10px;
    }
    .header h1 {
      margin: 0;
      font-size: 18px;
      color: var(--accent);
    }
    .ist-time {
      font-size: 24px;
      font-weight: 700;
      color: var(--ok);
      font-family: 'Courier New', monospace;
    }
    .ist-date {
      font-size: 12px;
      color: var(--muted);
    }
    
    /* Stats Grid */
    .top {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 10px;
      margin-bottom: 10px;
    }
    .card {
      border: 1px solid var(--line);
      background: linear-gradient(180deg, #111827, #0e1626);
      border-radius: 10px;
      padding: 10px;
      position: relative;
    }
    .card.danger {
      border-color: var(--danger);
      background: linear-gradient(180deg, #3f1818, #1f0a0a);
    }
    .card.warning {
      border-color: var(--warn);
      background: linear-gradient(180deg, #3f3018, #1f1a0a);
    }
    .card.success {
      border-color: var(--ok);
      background: linear-gradient(180deg, #183f1f, #0a1f0f);
    }
    .k { color: var(--muted); font-size: 11px; }
    .v { font-size: 16px; font-weight: 600; margin-top: 2px; }
    .v.small { font-size: 13px; }
    
    /* Broker Limit Meter */
    .limit-meter {
      display: flex;
      gap: 8px;
      margin-top: 5px;
    }
    .limit-bar {
      flex: 1;
      height: 6px;
      background: #1f2937;
      border-radius: 3px;
      overflow: hidden;
    }
    .limit-fill {
      height: 100%;
      border-radius: 3px;
      transition: width 0.3s ease;
    }
    .limit-fill.green { background: var(--ok); }
    .limit-fill.yellow { background: var(--warn); }
    .limit-fill.red { background: var(--danger); }
    
    .ctrl {
      display: flex;
      gap: 8px;
      align-items: center;
      border: 1px solid var(--line);
      background: var(--card);
      border-radius: 10px;
      padding: 10px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }
    input, button, a.nav, select {
      border: 1px solid var(--line);
      background: #0b1220;
      color: var(--text);
      border-radius: 8px;
      padding: 7px 10px;
      min-height: 34px;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
    }
    button { cursor: pointer; }
    button:hover { background: #1e293b; }
    button.export { background: #1e3a5f; }
    button.export:hover { background: #2d4a6f; }
    
    .grid2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .grid3 {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    .section-title {
      margin: 8px 0;
      color: #dbeafe;
      font-size: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .section-title .count {
      font-size: 12px;
      color: var(--muted);
      background: #1f2937;
      padding: 2px 8px;
      border-radius: 12px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      border: 1px solid var(--line);
      background: #0b1220;
      font-size: 11px;
    }
    th, td {
      border-bottom: 1px solid #1f2937;
      padding: 6px;
      text-align: left;
      white-space: nowrap;
    }
    th {
      position: sticky;
      top: 0;
      background: #111827;
      color: #d1d5db;
      z-index: 2;
      font-weight: 600;
    }
    .table-wrap {
      border: 1px solid var(--line);
      border-radius: 10px;
      overflow: auto;
      max-height: calc(100vh - 380px);
      background: #0b1220;
    }
    .pnl-pos { color: var(--ok); font-weight: 700; }
    .pnl-neg { color: var(--down); font-weight: 700; }
    .meta { color: var(--muted); margin-left: auto; }
    .sub { color: var(--muted); font-size: 10px; }
    .vol-hot { color: var(--warn); font-weight: 700; }
    
    /* Trade status badges */
    .badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
    }
    .badge-open { background: #166534; color: #86efac; }
    .badge-closed { background: #374151; color: #9ca3af; }
    .badge-tsl { background: #854d0e; color: #fde047; }
    
    /* Level colors */
    .sl-level { color: #fca5a5; }
    .tp-level { color: #86efac; }
    .entry-level { color: #93c5fd; }
    .current-level { color: #fde047; font-weight: 700; }
    
    /* Auto-close warning */
    .auto-close-warning {
      background: linear-gradient(90deg, #7c2d12, #92400e);
      border: 1px solid #ea580c;
      border-radius: 8px;
      padding: 8px 12px;
      margin-bottom: 10px;
      display: none;
    }
    .auto-close-warning.active {
      display: flex;
      align-items: center;
      gap: 10px;
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    
    /* Instrument type badge */
    .inst-badge {
      display: inline-block;
      padding: 1px 5px;
      border-radius: 3px;
      font-size: 9px;
      font-weight: 600;
      text-transform: uppercase;
    }
    .inst-equity { background: #1e3a5f; color: #7dd3fc; }
    .inst-option { background: #581c87; color: #d8b4fe; }
    .inst-future { background: #701a75; color: #f0abfc; }
    .inst-commodity { background: #7c2d12; color: #fdba74; }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Header with IST Time -->
    <div class="header">
      <div>
        <h1>üìà Superalgo Trade Monitor</h1>
        <div class="ist-date" id="istDate">-</div>
      </div>
      <div style="text-align: right;">
        <div class="ist-time" id="istTime">--:--:--</div>
        <div style="font-size: 11px; color: var(--muted);">IST (UTC+5:30)</div>
      </div>
    </div>

    <!-- Auto Close Warning -->
    <div class="auto-close-warning" id="autoCloseWarning">
      <span style="font-size: 20px;">‚ö†Ô∏è</span>
      <div>
        <strong>Market Closing Soon!</strong>
        <div style="font-size: 12px;">All NSE/BSE trades will auto-close at 3:28:30 PM IST. MCX at 11:30 PM IST.</div>
      </div>
    </div>

    <!-- Stats Cards -->
    <div class="top" id="stats"></div>

    <!-- Broker Limit Meter -->
    <div class="card" style="margin-bottom: 10px;">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <span class="k">Broker Limits Monitor</span>
        <span class="badge" id="brokerStatusBadge" style="background: #166534;">SAFE</span>
      </div>
      <div style="margin-top: 8px;">
        <div style="display: flex; justify-content: space-between; font-size: 11px; margin-bottom: 4px;">
          <span>Orders: <span id="ordersUsed">0</span> / <span id="ordersLimit">2000</span></span>
          <span id="ordersPct">0%</span>
        </div>
        <div class="limit-bar">
          <div class="limit-fill green" id="ordersBar" style="width: 0%"></div>
        </div>
      </div>
      <div style="margin-top: 8px;">
        <div style="display: flex; justify-content: space-between; font-size: 11px; margin-bottom: 4px;">
          <span>Positions: <span id="positionsUsed">0</span> / <span id="positionsLimit">100</span></span>
          <span id="positionsPct">0%</span>
        </div>
        <div class="limit-bar">
          <div class="limit-fill green" id="positionsBar" style="width: 0%"></div>
        </div>
      </div>
      <div style="margin-top: 8px; font-size: 11px; color: var(--muted);" id="brokerUpdated">
        Updated: -
      </div>
    </div>

    <div class="ctrl">
      <input id="search" type="text" placeholder="Search symbol or tsym" />
      <label>Open limit <input id="openLimit" type="number" value="500" min="1" max="5000" style="width:80px"/></label>
      <label>Closed limit <input id="closedLimit" type="number" value="1000" min="1" max="10000" style="width:80px"/></label>
      <label>Refresh(ms) <input id="refreshMs" type="number" value="2000" min="500" max="10000" style="width:90px"/></label>
      <button id="apply">Apply</button>
      <button class="export" id="exportCsv">Export CSV</button>
      <button class="export" id="exportJson">Export JSON</button>
      <a class="nav" href="/" target="_blank">Open Level Monitor</a>
      <span class="meta" id="meta">-</span>
    </div>

    <!-- Open Trades Section -->
    <div class="section-title">
      üü¢ Open Trades
      <span class="count" id="openCount">0</span>
    </div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Symbol</th>
            <th>Type</th>
            <th>Entry</th>
            <th>Current</th>
            <th>SL</th>
            <th>TP (BU5)</th>
            <th>TSL</th>
            <th>Qty</th>
            <th>Gross PnL</th>
            <th>Net PnL</th>
            <th>PnL%</th>
            <th>Runup</th>
            <th>DD</th>
            <th>Status</th>
            <th>Updated (IST)</th>
          </tr>
        </thead>
        <tbody id="openRows"></tbody>
      </table>
    </div>

    <div class="grid2" style="margin-top: 10px;">
      <div>
        <div class="section-title">
          üìä Recent Closed Trades
          <span class="count" id="closedCount">0</span>
        </div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Symbol</th>
                <th>Type</th>
                <th>Entry</th>
                <th>Exit</th>
                <th>Reason</th>
                <th>Net PnL</th>
                <th>Charges</th>
              </tr>
            </thead>
            <tbody id="closedRows"></tbody>
          </table>
        </div>
      </div>

      <div>
        <div class="section-title">
          üìà Trade Analysis
        </div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Metric</th>
                <th>Value</th>
              </tr>
            </thead>
            <tbody id="analysisRows"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="grid3">
      <div>
        <div class="section-title">üèÜ Top Profitable Trades</div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Symbol</th>
                <th>Type</th>
                <th>Net PnL</th>
              </tr>
            </thead>
            <tbody id="topClosedRows"></tbody>
          </table>
        </div>
      </div>

      <div>
        <div class="section-title">üìâ Worst Trades</div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Symbol</th>
                <th>Type</th>
                <th>Net PnL</th>
              </tr>
            </thead>
            <tbody id="worstClosedRows"></tbody>
          </table>
        </div>
      </div>

      <div>
        <div class="section-title">üî• Top Volume Leaders</div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Symbol</th>
                <th>Volume</th>
                <th>LTP</th>
              </tr>
            </thead>
            <tbody id="volumeRows"></tbody>
        </table>
        </div>
      </div>
    </div>

    <!-- Top Gainers/Losers -->
    <div class="grid2" style="margin-top: 10px;">
      <div>
        <div class="section-title">üöÄ Top 5 Gainers</div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Symbol</th>
                <th>Type</th>
                <th>LTP</th>
                <th>Change%</th>
              </tr>
            </thead>
            <tbody id="gainersRows"></tbody>
          </table>
        </div>
      </div>
      <div>
        <div class="section-title">üîª Top 5 Losers</div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Symbol</th>
                <th>Type</th>
                <th>LTP</th>
                <th>Change%</th>
              </tr>
            </thead>
            <tbody id="losersRows"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    const statsEl = document.getElementById('stats');
    const openRowsEl = document.getElementById('openRows');
    const closedRowsEl = document.getElementById('closedRows');
    const topClosedRowsEl = document.getElementById('topClosedRows');
    const worstClosedRowsEl = document.getElementById('worstClosedRows');
    const volumeRowsEl = document.getElementById('volumeRows');
    const analysisRowsEl = document.getElementById('analysisRows');
    const gainersRowsEl = document.getElementById('gainersRows');
    const losersRowsEl = document.getElementById('losersRows');
    const metaEl = document.getElementById('meta');
    const istTimeEl = document.getElementById('istTime');
    const istDateEl = document.getElementById('istDate');
    const autoCloseWarningEl = document.getElementById('autoCloseWarning');
    const openCountEl = document.getElementById('openCount');
    const closedCountEl = document.getElementById('closedCount');

    const searchEl = document.getElementById('search');
    const openLimitEl = document.getElementById('openLimit');
    const closedLimitEl = document.getElementById('closedLimit');
    const refreshMsEl = document.getElementById('refreshMs');
    const applyEl = document.getElementById('apply');
    const exportCsvEl = document.getElementById('exportCsv');
    const exportJsonEl = document.getElementById('exportJson');

    let timer = null;

    function f2(v) {
      if (v === null || v === undefined || v === '') return '-';
      const n = Number(v);
      return Number.isFinite(n) ? n.toFixed(2) : String(v);
    }
    
    function f4(v) {
      if (v === null || v === undefined || v === '') return '-';
      const n = Number(v);
      return Number.isFinite(n) ? n.toFixed(4) : String(v);
    }

    function safe(obj, path, d = '-') {
      let cur = obj;
      for (const p of path) {
        if (!cur || typeof cur !== 'object' || !(p in cur)) return d;
        cur = cur[p];
      }
      return cur ?? d;
    }

    function pnlClass(v) {
      const n = Number(v || 0);
      if (n > 0) return 'pnl-pos';
      if (n < 0) return 'pnl-neg';
      return '';
    }

    function label(r) {
      return r.display_symbol || r.tsym || r.symbol || '-';
    }
    
    function instBadge(r) {
      const type = r.instrument_type || 'EQUITY';
      const cls = {
        'EQUITY': 'inst-equity',
        'OPTION': 'inst-option',
        'FUTURE': 'inst-future',
        'COMMODITY': 'inst-commodity',
        'DERIVATIVE': 'inst-future'
      }[type] || 'inst-equity';
      return `<span class="inst-badge ${cls}">${type}</span>`;
    }
    
    function formatISTTime() {
      const now = new Date();
      return now.toLocaleTimeString('en-IN', { 
        timeZone: 'Asia/Kolkata',
        hour12: false,
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
    }
    
    function formatISTDate() {
      const now = new Date();
      return now.toLocaleDateString('en-IN', { 
        timeZone: 'Asia/Kolkata',
        weekday: 'short',
        year: 'numeric',
        month: 'short',
        day: 'numeric'
      });
    }
    
    function checkAutoClose(status) {
      const marketTime = status?.market_time || {};
      const nseClose = marketTime.auto_close_nse_bse;
      const mcxClose = marketTime.auto_close_mcx;
      
      // Show warning if within 5 minutes of close
      if (nseClose || mcxClose) {
        autoCloseWarningEl.classList.add('active');
      } else {
        autoCloseWarningEl.classList.remove('active');
      }
    }
    
    function updateBrokerLimits(limits) {
      if (!limits) return;
      
      document.getElementById('ordersUsed').textContent = limits.orders_placed || 0;
      document.getElementById('ordersLimit').textContent = limits.orders_limit || 2000;
      document.getElementById('ordersPct').textContent = (limits.orders_pct_used || 0) + '%';
      document.getElementById('positionsUsed').textContent = limits.open_positions || 0;
      document.getElementById('positionsLimit').textContent = limits.positions_limit || 100;
      document.getElementById('positionsPct').textContent = (limits.positions_pct_used || 0) + '%';
      document.getElementById('brokerUpdated').textContent = 'Updated: ' + (limits.updated_at || '-');
      
      // Update bars
      const ordersBar = document.getElementById('ordersBar');
      const positionsBar = document.getElementById('positionsBar');
      const badge = document.getElementById('brokerStatusBadge');
      
      ordersBar.style.width = Math.min(100, parseFloat(limits.orders_pct_used || 0)) + '%';
      positionsBar.style.width = Math.min(100, parseFloat(limits.positions_pct_used || 0)) + '%';
      
      // Update colors
      const color = limits.status_color || 'green';
      ordersBar.className = `limit-fill ${color}`;
      positionsBar.className = `limit-fill ${color}`;
      
      if (color === 'green') {
        badge.textContent = 'SAFE';
        badge.style.background = '#166534';
      } else if (color === 'yellow') {
        badge.textContent = 'WARNING';
        badge.style.background = '#854d0e';
      } else {
        badge.textContent = 'DANGER';
        badge.style.background = '#7f1d1d';
      }
    }

    function statCards(data) {
      const s = data.summary || {};
      const st = data.status || {};
      const an = data.analysis || {};
      const pd = safe(st, ['past_data_download'], {});
      const ws = safe(st, ['websocket'], {});
      const login = safe(st, ['login'], {});
      const top = an.top_performer || {};
      const limits = st.broker_limits || {};

      const cards = [
        ['Trade Mode', `${safe(s, ['trade_mode'], '-')} / ${safe(s, ['engine_state'], '-')}`],
        ['Open Trades', safe(s, ['open_trades'], 0)],
        ['Closed Trades', safe(s, ['closed_trades'], 0)],
        ['Win Rate %', f2(safe(s, ['win_rate'], 0))],
        ['Realized PnL', '‚Çπ' + f2(safe(s, ['realized_pnl'], 0))],
        ['Open PnL', '‚Çπ' + f2(safe(s, ['open_pnl'], 0))],
        ['Gross PnL', '‚Çπ' + f2(safe(s, ['gross_pnl'], 0))],
        ['Total Charges', '‚Çπ' + f2(safe(s, ['total_charges'], 0))],
        ['Net PnL', '‚Çπ' + f2(safe(s, ['net_pnl'], 0))],
        ['Max Drawdown', '‚Çπ' + f2(safe(s, ['max_drawdown'], 0))],
        ['Top Performer', `${label(top)} (‚Çπ${f2(top.net_pnl || top.pnl)})`],
        ['Avg Volume', f2(safe(an, ['average_volume'], 0))],
        ['Login', login.ok ? 'OK' : 'NO'],
        ['WebSocket', ws.open ? 'OPEN' : 'DOWN'],
        ['Backfill %', f2(safe(pd, ['progress_pct'], 0))],
        ['Backfill Rows', safe(pd, ['history_rows'], 0)],
      ];

      statsEl.innerHTML = cards.map(([k, v]) => `
        <div class="card"><div class="k">${k}</div><div class="v">${v}</div></div>
      `).join('');
      
      // Update broker limits
      updateBrokerLimits(limits);
      
      // Update counts
      openCountEl.textContent = safe(s, ['open_trades'], 0);
      closedCountEl.textContent = safe(s, ['closed_trades'], 0);
      
      // Check auto-close warning
      checkAutoClose(st);
    }
    
    function renderAnalysis(data) {
      const s = data.summary || {};
      const analysis = [
        ['Strategy Timeframe', safe(s, ['strategy_tf'], '-')],
        ['Strategy Factor', safe(s, ['strategy_factor'], '-')],
        ['Total Trades Today', safe(s, ['total_trades'], 0)],
        ['Winning Trades', safe(s, ['wins'], 0)],
        ['Losing Trades', safe(s, ['losses'], 0)],
        ['Peak Equity', '‚Çπ' + f2(safe(s, ['peak_equity'], 0))],
        ['Current Drawdown', '‚Çπ' + f2(safe(s, ['drawdown_now'], 0))],
        ['Analysis Time', safe(data, ['ist_datetime'], '-').split(',')[1] || '-'],
      ];
      
      analysisRowsEl.innerHTML = analysis.map(([k, v]) => `
        <tr><td>${k}</td><td class="v">${v}</td></tr>
      `).join('');
    }

    function renderOpen(rows) {
      openRowsEl.innerHTML = (rows || []).map(r => {
        const tslActive = r.tsl_active ? `<span class="badge badge-tsl">TSL</span>` : '';
        const statusBadge = `<span class="badge badge-open">OPEN</span>${tslActive}`;
        
        return `
        <tr>
          <td><strong>${label(r)}</strong><br><span class="sub">${r.symbol || ''}</span></td>
          <td>${instBadge(r)}</td>
          <td class="entry-level">${f2(r.entry_ltp)}</td>
          <td class="current-level">${f2(r.last_ltp)}</td>
          <td class="sl-level">${f2(r.tsl_active ? r.tsl_sl_price : r.sl_price)} ${r.tsl_active ? 'üîí' : ''}</td>
          <td class="tp-level">${f2(r.tp_price)}</td>
          <td>${r.tsl_active ? f2(r.tsl_sl_price) : '-'}</td>
          <td>${r.quantity || 1}</td>
          <td class="${pnlClass(r.pnl)}">‚Çπ${f2(r.pnl)}</td>
          <td class="${pnlClass(r.net_pnl || r.pnl)}">‚Çπ${f2(r.net_pnl || r.pnl)}</td>
          <td class="${pnlClass(r.pnl_pct)}">${f2(r.pnl_pct)}%</td>
          <td class="pnl-pos">+${f2(r.runup)}</td>
          <td class="pnl-neg">-${f2(r.drawdown)}</td>
          <td>${statusBadge}</td>
          <td>${r.ist_time || r.updated_at?.split('T')[1]?.slice(0, 8) || '-'}</td>
        </tr>
      `}).join('');
    }

    function renderClosed(rows) {
      closedRowsEl.innerHTML = (rows || []).map(r => {
        const statusClass = (r.net_pnl || r.pnl) > 0 ? 'pnl-pos' : 'pnl-neg';
        return `
        <tr>
          <td><strong>${label(r)}</strong><br><span class="sub">${r.symbol || ''}</span></td>
          <td>${instBadge(r)}</td>
          <td>${f2(r.entry_ltp)}</td>
          <td>${f2(r.exit_ltp)}</td>
          <td><span class="badge badge-closed">${r.reason || 'CLOSED'}</span></td>
          <td class="${statusClass}">‚Çπ${f2(r.net_pnl || r.pnl)}</td>
          <td>‚Çπ${f2(r.total_charges || 0)}</td>
        </tr>
      `}).join('');
    }

    function renderTopClosed(rows) {
      topClosedRowsEl.innerHTML = (rows || []).map(r => `
        <tr>
          <td>${label(r)}</td>
          <td>${instBadge(r)}</td>
          <td class="pnl-pos">‚Çπ${f2(r.net_pnl || r.pnl)}</td>
        </tr>
      `).join('');
    }

    function renderWorstClosed(rows) {
      worstClosedRowsEl.innerHTML = (rows || []).map(r => `
        <tr>
          <td>${label(r)}</td>
          <td>${instBadge(r)}</td>
          <td class="pnl-neg">‚Çπ${f2(r.net_pnl || r.pnl)}</td>
        </tr>
      `).join('');
    }

    function renderVolumes(rows) {
      volumeRowsEl.innerHTML = (rows || []).map(r => {
        const hot = Number(r.volume_vs_avg || 0) >= 2 ? 'vol-hot' : '';
        return `
          <tr>
            <td>${r.display_symbol ?? r.symbol ?? '-'}</td>
            <td class="${hot}">${f2(r.volume)}</td>
            <td>${f2(r.ltp)}</td>
          </tr>
        `;
      }).join('');
    }
    
    function renderGainers(rows) {
      gainersRowsEl.innerHTML = (rows || []).map(r => `
        <tr>
          <td>${r.display_symbol || r.symbol || '-'}</td>
          <td>${instBadge(r)}</td>
          <td>${f2(r.ltp)}</td>
          <td class="pnl-pos">+${f2(r.change_pct)}%</td>
        </tr>
      `).join('');
    }
    
    function renderLosers(rows) {
      losersRowsEl.innerHTML = (rows || []).map(r => `
        <tr>
          <td>${r.display_symbol || r.symbol || '-'}</td>
          <td>${instBadge(r)}</td>
          <td>${f2(r.ltp)}</td>
          <td class="pnl-neg">${f2(r.change_pct)}%</td>
        </tr>
      `).join('');
    }

    async function refresh() {
      const q = encodeURIComponent(searchEl.value || '');
      const openLimit = Math.max(1, Math.min(5000, Number(openLimitEl.value || 500)));
      const closedLimit = Math.max(1, Math.min(10000, Number(closedLimitEl.value || 1000)));
      const t0 = performance.now();

      try {
        const res = await fetch(`/api/trades?q=${q}&open_limit=${openLimit}&closed_limit=${closedLimit}`);
        const data = await res.json();

        statCards(data);
        renderAnalysis(data);
        renderOpen(data.open_trades || []);
        renderClosed(data.recent_closed || []);
        renderTopClosed(safe(data, ['analysis', 'top_closed'], []));
        renderWorstClosed(safe(data, ['analysis', 'worst_closed'], []));
        renderVolumes(safe(data, ['analysis', 'volume_leaders'], []));
        renderGainers(safe(data, ['analysis', 'top_gainers'], []));
        renderLosers(safe(data, ['analysis', 'top_losers'], []));

        metaEl.textContent = `open:${(data.open_trades || []).length} | closed:${(data.recent_closed || []).length} | load:${(performance.now()-t0).toFixed(0)}ms | IST:${data.ist_time || '-'}`;
      } catch (e) {
        metaEl.textContent = 'Error: ' + e.message;
      }
    }
    
    async function exportTrades(format) {
      try {
        const res = await fetch(`/api/export?format=${format}`);
        const data = await res.json();
        if (data.success) {
          alert(`Export successful!\nFilename: ${data.filename}\nTrades: ${data.count}\nTime: ${data.ist_time}`);
          // Trigger download
          window.open(data.download_url, '_blank');
        } else {
          alert('Export failed: ' + (data.error || 'Unknown error'));
        }
      } catch (e) {
        alert('Export error: ' + e.message);
      }
    }

    function restartLoop() {
      if (timer) clearInterval(timer);
      const ms = Math.max(500, Math.min(10000, Number(refreshMsEl.value || 2000)));
      refresh();
      timer = setInterval(refresh, ms);
    }
    
    // Update IST time every second
    setInterval(() => {
      istTimeEl.textContent = formatISTTime();
      istDateEl.textContent = formatISTDate();
    }, 1000);
    
    // Initial time set
    istTimeEl.textContent = formatISTTime();
    istDateEl.textContent = formatISTDate();

    applyEl.addEventListener('click', restartLoop);
    exportCsvEl.addEventListener('click', () => exportTrades('csv'));
    exportJsonEl.addEventListener('click', () => exportTrades('json'));
    restartLoop();
  </script>
</body>
</html>
